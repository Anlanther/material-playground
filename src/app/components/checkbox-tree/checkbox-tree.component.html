<div class="checkbox-tree-container">
  <!-- Search Filter -->
  <app-search-filter
    [searchControl]="searchControl"
    [showSearchFilter]="showSearchFilter"
    (clearSearch)="clearSearch()"
  ></app-search-filter>

  <!-- Tree Section -->
  <div class="tree-section">
    <div class="tree-header">
      <h3>Select Items</h3>
      <div class="header-actions">
        <button
          mat-button
          color="primary"
          (click)="saveCurrentState()"
          [disabled]="(store.selectedCount$ | async) === 0"
        >
          Save State
        </button>
        <button mat-button color="accent" (click)="clearSavedState()">
          Clear Saved
        </button>
        <button
          mat-button
          color="warn"
          (click)="clearAllSelections()"
          [disabled]="(store.selectedCount$ | async) === 0"
        >
          Clear All
        </button>
      </div>
    </div>

    <div class="tree-container">
      <div class="tree-list">
        <ng-container
          *ngFor="let node of getTopLevelNodes(); trackBy: trackByNodeId"
        >
          <ng-container
            *ngTemplateOutlet="
              treeNodeTemplate;
              context: { $implicit: node, level: 0 }
            "
          ></ng-container>
        </ng-container>
      </div>
    </div>
  </div>

  <!-- Recursive Tree Node Template -->
  <ng-template #treeNodeTemplate let-node let-level="level">
    <div
      class="tree-node"
      [class.top-level-node]="level === 0"
      [class.child-node]="level > 0"
    >
      <div class="node-content" [style.padding-left]="getNodePadding(node)">
        <!-- Expand/Collapse button for nodes with children -->
        <button
          *ngIf="hasChild(node)"
          mat-icon-button
          (click)="toggleExpansion(node)"
          class="expand-button"
          [attr.aria-label]="'Toggle ' + node.name"
        >
          <mat-icon>
            {{
              isExpanded(node) ? "keyboard_arrow_down" : "keyboard_arrow_right"
            }}
          </mat-icon>
        </button>

        <!-- Spacer for leaf nodes -->
        <div *ngIf="!hasChild(node)" class="node-spacer"></div>

        <!-- Checkbox -->
        <mat-checkbox
          [checked]="getCheckboxState(node).checked"
          [indeterminate]="getCheckboxState(node).indeterminate"
          (change)="toggleNodeSelection(node)"
          class="node-checkbox"
        >
          {{ node.name }}
        </mat-checkbox>
      </div>

      <!-- Child nodes container (with or without scroll) -->
      <div
        *ngIf="hasChild(node) && isExpanded(node)"
        class="child-nodes-container"
        [class.child-nodes-scroll]="level === 0"
      >
        <ng-container
          *ngFor="let childNode of getChildNodes(node); trackBy: trackByNodeId"
        >
          <ng-container
            *ngTemplateOutlet="
              treeNodeTemplate;
              context: { $implicit: childNode, level: level + 1 }
            "
          ></ng-container>
        </ng-container>
      </div>
    </div>
  </ng-template>

  <!-- Selected Items Section -->
  <app-selected-items
    [selectedNodes]="selectedNodes"
    [selectedCount$]="store.selectedCount$"
    [maxChildHeight]="maxChildHeight"
    [showSelectedItems]="showSelectedItems"
  ></app-selected-items>
</div>
