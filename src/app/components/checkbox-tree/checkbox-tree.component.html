<div class="checkbox-tree-container">
  <!-- Search Filter -->
  <div class="search-section" *ngIf="showSearchFilter">
    <mat-form-field appearance="outline" class="search-field">
      <mat-label>Search tree...</mat-label>
      <input
        matInput
        [formControl]="searchControl"
        placeholder="Type to filter nodes"
      />
      <mat-icon matSuffix>search</mat-icon>
      <button
        mat-icon-button
        matSuffix
        *ngIf="searchControl.value"
        (click)="clearSearch()"
        aria-label="Clear search"
      >
        <mat-icon>close</mat-icon>
      </button>
    </mat-form-field>
  </div>

  <!-- Tree Section -->
  <div class="tree-section">
    <div class="tree-header">
      <h3>Select Items</h3>
      <div class="header-actions">
        <button
          mat-button
          color="primary"
          (click)="saveCurrentState()"
          [disabled]="(store.selectedCount$ | async) === 0"
        >
          Save State
        </button>
        <button mat-button color="accent" (click)="clearSavedState()">
          Clear Saved
        </button>
        <button
          mat-button
          color="warn"
          (click)="clearAllSelections()"
          [disabled]="(store.selectedCount$ | async) === 0"
        >
          Clear All
        </button>
      </div>
    </div>

    <div class="tree-container">
      <div class="tree-list">
        <ng-container
          *ngFor="let node of getTopLevelNodes(); trackBy: trackByNodeId"
        >
          <ng-container
            *ngTemplateOutlet="
              treeNodeTemplate;
              context: { $implicit: node, level: 0 }
            "
          ></ng-container>
        </ng-container>
      </div>
    </div>
  </div>

  <!-- Recursive Tree Node Template -->
  <ng-template #treeNodeTemplate let-node let-level="level">
    <div
      class="tree-node"
      [class.top-level-node]="level === 0"
      [class.child-node]="level > 0"
    >
      <div class="node-content" [style.padding-left]="getNodePadding(node)">
        <!-- Expand/Collapse button for nodes with children -->
        <button
          *ngIf="hasChild(node)"
          mat-icon-button
          (click)="toggleExpansion(node)"
          class="expand-button"
          [attr.aria-label]="'Toggle ' + node.name"
        >
          <mat-icon>
            {{
              isExpanded(node) ? "keyboard_arrow_down" : "keyboard_arrow_right"
            }}
          </mat-icon>
        </button>

        <!-- Spacer for leaf nodes -->
        <div *ngIf="!hasChild(node)" class="node-spacer"></div>

        <!-- Checkbox -->
        <mat-checkbox
          [checked]="getCheckboxState(node).checked"
          [indeterminate]="getCheckboxState(node).indeterminate"
          (change)="toggleNodeSelection(node)"
          class="node-checkbox"
        >
          {{ node.name }}
        </mat-checkbox>
      </div>

      <!-- Child nodes container (with or without scroll) -->
      <div
        *ngIf="hasChild(node) && isExpanded(node)"
        class="child-nodes-container"
        [class.child-nodes-scroll]="level === 0"
      >
        <ng-container
          *ngFor="let childNode of getChildNodes(node); trackBy: trackByNodeId"
        >
          <ng-container
            *ngTemplateOutlet="
              treeNodeTemplate;
              context: { $implicit: childNode, level: level + 1 }
            "
          ></ng-container>
        </ng-container>
      </div>
    </div>
  </ng-template>

  <!-- Selected Items Section -->
  <div class="selected-section" *ngIf="showSelectedItems">
    <div class="selected-header">
      <h3>Selected Items ({{ (store.selectedCount$ | async) || 0 }})</h3>
    </div>

    <div class="selected-container" [style.max-height]="maxChildHeight">
      <div
        class="selected-items"
        *ngIf="selectedNodes.length > 0; else noSelection"
      >
        <mat-chip-set>
          <mat-chip
            *ngFor="
              let item of selectedNodes;
              let i = index;
              trackBy: trackBySelectedItem
            "
          >
            {{ item }}
          </mat-chip>
        </mat-chip-set>
      </div>

      <ng-template #noSelection>
        <div class="no-selection">
          <mat-icon>info</mat-icon>
          <span>No items selected</span>
        </div>
      </ng-template>
    </div>
  </div>
</div>
